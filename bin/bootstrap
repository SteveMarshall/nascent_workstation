#!/usr/bin/env bash

reset="$(tput sgr0)"
 bold="$(tput bold)"
  red="$(tput setaf 1)"

if [[ ! -f nodes/`hostname`.json ]]; then
  echo -e "${bold}${red}No nodefile for this machine (`hostname`).${reset}"
  exit 1
fi

# Configure homedir if needs be
if [[ -d ~/.git ]]; then
  cd && git pull
else
  cd && git clone https://github.com/SteveMarshall/homedir.git && chflags hidden ~/homedir/* && mv ~/homedir/* ~ && mv ~/homedir/.* ~ && rm -rf ~/homedir
fi
source ~/.bash_profile

# Install Chef using the Omnibus installer
# Omnibus updater in chef itself will handle updates for us
if [[ ! -f /usr/bin/chef-solo ]]; then
    curl -L https://www.opscode.com/chef/install.sh | sudo bash
    sudo chflags hidden /opt
fi

# Configure homebrew and rbenv if needs be
if [[ -f /usr/local/bin/brew ]]; then
    brew update
else
    # HACK: Use an admin account, just in case this account is non-admin already
    sudo -u StevenAdm /usr/bin/ruby -e "$(curl -fsSL https://raw.github.com/Homebrew/homebrew/go/install)"
    sudo chown -R smarshall:admin /usr/local
fi
if [[ ! -f /usr/local/bin/rbenv ]]; then
    brew install rbenv ruby-build
fi
if [[ ! -f ~/.rbenv/shims/ruby ]]; then
    env CC=/usr/bin/gcc rbenv install 1.9.3-p385
    rbenv global 1.9.3-p385
    rbenv rehash
fi

# Update/grab all the cookbooks
if [[ ! -d ~/Development/Personal ]]; then
  mkdir -p ~/Development/Personal
fi

if [[ -d ~/Development/Personal/nascent_workstation ]]; then
  cd ~/Development/Personal/nascent_workstation && git pull
else
  cd ~/Development/Personal && git clone https://github.com/SteveMarshall/nascent_workstation.git
fi

# Bootstrap using Chef
cd ~/Development/Personal/nascent_workstation
rm -f *.lock
bundle install
bundle exec berks install --path .cookbooks

if [[ -f nodes/`hostname`.json ]]; then
  sudo chef-solo -c solo.rb -j nodes/`hostname`.json
fi
